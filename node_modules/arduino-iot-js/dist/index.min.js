!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CreatePlugin=t()}(this,function(){"use strict";function e(e,t){return t={exports:{}},e(t,t.exports),t.exports}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(o,s){try{var i=t[o](s),c=i.value}catch(e){return void n(e)}if(!i.done)return Promise.resolve(c).then(function(e){r("next",e)},function(e){r("throw",e)});e(c)}return r("next")})}}var s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},i=e(function(e,t){!function(t,n){e.exports=n()}(0,function(){return function(e){function t(e,t){var n=t,r=e[t],s=r>>4,i=r&=15;t+=1;var c,u=0,h=1;do{if(t==e.length)return[null,n];u+=(127&(c=e[t++]))*h,h*=128}while(0!=(128&c));var l=t+u;if(l>e.length)return[null,n];var d=new y(s);switch(s){case f.CONNACK:1&e[t++]&&(d.sessionPresent=!0),d.returnCode=e[t++];break;case f.PUBLISH:var p=i>>1&3,g=o(e,t),_=a(e,t+=2,g);t+=g,p>0&&(d.messageIdentifier=o(e,t),t+=2);var v=new w(e.subarray(t,l));1==(1&i)&&(v.retained=!0),8==(8&i)&&(v.duplicate=!0),v.qos=p,v.destinationName=_,d.payloadMessage=v;break;case f.PUBACK:case f.PUBREC:case f.PUBREL:case f.PUBCOMP:case f.UNSUBACK:d.messageIdentifier=o(e,t);break;case f.SUBACK:d.messageIdentifier=o(e,t),t+=2,d.returnCode=e.subarray(t,l)}return[d,l]}function n(e,t,n){return t[n++]=e>>8,t[n++]=e%256,n}function r(e,t,r,o){return o=n(t,r,o),c(e,r,o),o+t}function o(e,t){return 256*e[t]+e[t+1]}function s(e){var t=Array(1),n=0;do{var r=e%128;(e>>=7)>0&&(r|=128),t[n++]=r}while(e>0&&4>n);return t}function i(e){for(var t=0,n=0;e.length>n;n++){var r=e.charCodeAt(n);r>2047?(55296>r||r>56319||(n++,t++),t+=3):r>127?t+=2:t++}return t}function c(e,t,n){for(var r=n,o=0;e.length>o;o++){var s=e.charCodeAt(o);if(s>=55296&&56319>=s){var i=e.charCodeAt(++o);if(isNaN(i))throw Error(g(d.MALFORMED_UNICODE,[s,i]));s=i-56320+(s-55296<<10)+65536}s>127?s>2047?s>65535?(t[r++]=s>>18&7|240,t[r++]=s>>12&63|128,t[r++]=s>>6&63|128,t[r++]=63&s|128):(t[r++]=s>>12&15|224,t[r++]=s>>6&63|128,t[r++]=63&s|128):(t[r++]=s>>6&31|192,t[r++]=63&s|128):t[r++]=s}return t}function a(e,t,n){for(var r,o="",s=t;t+n>s;){var i=e[s++];if(128>i)r=i;else{var c=e[s++]-128;if(0>c)throw Error(g(d.MALFORMED_UTF,[i.toString(16),c.toString(16),""]));if(224>i)r=64*(i-192)+c;else{var a=e[s++]-128;if(0>a)throw Error(g(d.MALFORMED_UTF,[i.toString(16),c.toString(16),a.toString(16)]));if(240>i)r=4096*(i-224)+64*c+a;else{var u=e[s++]-128;if(0>u)throw Error(g(d.MALFORMED_UTF,[i.toString(16),c.toString(16),a.toString(16),u.toString(16)]));if(i>=248)throw Error(g(d.MALFORMED_UTF,[i.toString(16),c.toString(16),a.toString(16),u.toString(16)]));r=262144*(i-240)+4096*c+64*a+u}}}r>65535&&(r-=65536,o+=String.fromCharCode(55296+(r>>10)),r=56320+(1023&r)),o+=String.fromCharCode(r)}return o}var u=e.localStorage||function(){var e={};return{setItem:function(t,n){e[t]=n},getItem:function(t){return e[t]},removeItem:function(t){delete e[t]}}}(),f={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},h=function(e,t){for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n)){var r="Unknown property, "+n+". Valid properties are:";for(var o in t)t.hasOwnProperty(o)&&(r=r+" "+o);throw Error(r)}if(typeof e[n]!==t[n])throw Error(g(d.INVALID_TYPE,[typeof e[n],n]))}},l=function(e,t){return function(){return e.apply(t,arguments)}},d={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."},BUFFER_FULL:{code:18,text:"AMQJS0018E Message buffer is full, maximum buffer size: {0}."}},p={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"},g=function(e,t){var n=e.text;if(t)for(var r,o,s=0;t.length>s;s++)if(r="{"+s+"}",(o=n.indexOf(r))>0){var i=n.substring(0,o),c=n.substring(o+r.length);n=i+t[s]+c}return n},_=[0,6,77,81,73,115,100,112,3],v=[0,4,77,81,84,84,4],y=function(e,t){this.type=e;for(var n in t)t.hasOwnProperty(n)&&(this[n]=t[n])};y.prototype.encode=function(){var e,t=(15&this.type)<<4,o=0,c=[],a=0;switch(void 0!==this.messageIdentifier&&(o+=2),this.type){case f.CONNECT:switch(this.mqttVersion){case 3:o+=_.length+3;break;case 4:o+=v.length+3}o+=i(this.clientId)+2,void 0!==this.willMessage&&(o+=i(this.willMessage.destinationName)+2,(e=this.willMessage.payloadBytes)instanceof Uint8Array||(e=new Uint8Array(u)),o+=e.byteLength+2),void 0!==this.userName&&(o+=i(this.userName)+2),void 0!==this.password&&(o+=i(this.password)+2);break;case f.SUBSCRIBE:t|=2;for(y=0;this.topics.length>y;y++)o+=(c[y]=i(this.topics[y]))+2;o+=this.requestedQos.length;break;case f.UNSUBSCRIBE:t|=2;for(y=0;this.topics.length>y;y++)o+=(c[y]=i(this.topics[y]))+2;break;case f.PUBREL:t|=2;break;case f.PUBLISH:this.payloadMessage.duplicate&&(t|=8),t=t|=this.payloadMessage.qos<<1,this.payloadMessage.retained&&(t|=1),o+=(a=i(this.payloadMessage.destinationName))+2;var u=this.payloadMessage.payloadBytes;o+=u.byteLength,u instanceof ArrayBuffer?u=new Uint8Array(u):u instanceof Uint8Array||(u=new Uint8Array(u.buffer))}var h=s(o),l=h.length+1,d=new ArrayBuffer(o+l),p=new Uint8Array(d);if(p[0]=t,p.set(h,1),this.type==f.PUBLISH)l=r(this.payloadMessage.destinationName,a,p,l);else if(this.type==f.CONNECT){switch(this.mqttVersion){case 3:p.set(_,l),l+=_.length;break;case 4:p.set(v,l),l+=v.length}var g=0;this.cleanSession&&(g=2),void 0!==this.willMessage&&(g|=4,g|=this.willMessage.qos<<3,this.willMessage.retained&&(g|=32)),void 0!==this.userName&&(g|=128),void 0!==this.password&&(g|=64),p[l++]=g,l=n(this.keepAliveInterval,p,l)}switch(void 0!==this.messageIdentifier&&(l=n(this.messageIdentifier,p,l)),this.type){case f.CONNECT:l=r(this.clientId,i(this.clientId),p,l),void 0!==this.willMessage&&(l=r(this.willMessage.destinationName,i(this.willMessage.destinationName),p,l),l=n(e.byteLength,p,l),p.set(e,l),l+=e.byteLength),void 0!==this.userName&&(l=r(this.userName,i(this.userName),p,l)),void 0!==this.password&&(l=r(this.password,i(this.password),p,l));break;case f.PUBLISH:p.set(u,l);break;case f.SUBSCRIBE:for(y=0;this.topics.length>y;y++)l=r(this.topics[y],c[y],p,l),p[l++]=this.requestedQos[y];break;case f.UNSUBSCRIBE:for(var y=0;this.topics.length>y;y++)l=r(this.topics[y],c[y],p,l)}return d};var m=function(e,t){this._client=e,this._keepAliveInterval=1e3*t,this.isReset=!1;var n=new y(f.PINGREQ).encode(),r=function(e){return function(){return o.apply(e)}},o=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(n),this.timeout=setTimeout(r(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(d.PING_TIMEOUT.code,g(d.PING_TIMEOUT)))};this.reset=function(){this.isReset=!0,clearTimeout(this.timeout),this._keepAliveInterval>0&&(this.timeout=setTimeout(r(this),this._keepAliveInterval))},this.cancel=function(){clearTimeout(this.timeout)}},E=function(e,t,n,r){t||(t=30);this.timeout=setTimeout(function(e,t,n){return function(){return e.apply(t,n)}}(n,e,r),1e3*t),this.cancel=function(){clearTimeout(this.timeout)}},I=function(t,n,r,o,s){if(!("WebSocket"in e&&null!==e.WebSocket))throw Error(g(d.UNSUPPORTED,["WebSocket"]));if(!("ArrayBuffer"in e&&null!==e.ArrayBuffer))throw Error(g(d.UNSUPPORTED,["ArrayBuffer"]));this._trace("Paho.Client",t,n,r,o,s),this.host=n,this.port=r,this.path=o,this.uri=t,this.clientId=s,this._wsuri=null,this._localKey=n+":"+r+("/mqtt"!=o?":"+o:"")+":"+s+":",this._msg_queue=[],this._buffered_msg_queue=[],this._sentMessages={},this._receivedMessages={},this._notify_msg_sent={},this._message_identifier=1,this._sequence=0;for(var i in u)0!==i.indexOf("Sent:"+this._localKey)&&0!==i.indexOf("Received:"+this._localKey)||this.restore(i)};I.prototype.host=null,I.prototype.port=null,I.prototype.path=null,I.prototype.uri=null,I.prototype.clientId=null,I.prototype.socket=null,I.prototype.connected=!1,I.prototype.maxMessageIdentifier=65536,I.prototype.connectOptions=null,I.prototype.hostIndex=null,I.prototype.onConnected=null,I.prototype.onConnectionLost=null,I.prototype.onMessageDelivered=null,I.prototype.onMessageArrived=null,I.prototype.traceFunction=null,I.prototype._msg_queue=null,I.prototype._buffered_msg_queue=null,I.prototype._connectTimeout=null,I.prototype.sendPinger=null,I.prototype.receivePinger=null,I.prototype._reconnectInterval=1,I.prototype._reconnecting=!1,I.prototype._reconnectTimeout=null,I.prototype.disconnectedPublishing=!1,I.prototype.disconnectedBufferSize=5e3,I.prototype.receiveBuffer=null,I.prototype._traceBuffer=null,I.prototype._MAX_TRACE_ENTRIES=100,I.prototype.connect=function(e){var t=this._traceMask(e,"password");if(this._trace("Client.connect",t,this.socket,this.connected),this.connected)throw Error(g(d.INVALID_STATE,["already connected"]));if(this.socket)throw Error(g(d.INVALID_STATE,["already connected"]));this._reconnecting&&(this._reconnectTimeout.cancel(),this._reconnectTimeout=null,this._reconnecting=!1),this.connectOptions=e,this._reconnectInterval=1,this._reconnecting=!1,e.uris?(this.hostIndex=0,this._doConnect(e.uris[0])):this._doConnect(this.uri)},I.prototype.subscribe=function(e,t){if(this._trace("Client.subscribe",e,t),!this.connected)throw Error(g(d.INVALID_STATE,["not connected"]));var n=new y(f.SUBSCRIBE);n.topics=e.constructor===Array?e:[e],void 0===t.qos&&(t.qos=0),n.requestedQos=[];for(var r=0;n.topics.length>r;r++)n.requestedQos[r]=t.qos;t.onSuccess&&(n.onSuccess=function(e){t.onSuccess({invocationContext:t.invocationContext,grantedQos:e})}),t.onFailure&&(n.onFailure=function(e){t.onFailure({invocationContext:t.invocationContext,errorCode:e,errorMessage:g(e)})}),t.timeout&&(n.timeOut=new E(this,t.timeout,t.onFailure,[{invocationContext:t.invocationContext,errorCode:d.SUBSCRIBE_TIMEOUT.code,errorMessage:g(d.SUBSCRIBE_TIMEOUT)}])),this._requires_ack(n),this._schedule_message(n)},I.prototype.unsubscribe=function(e,t){if(this._trace("Client.unsubscribe",e,t),!this.connected)throw Error(g(d.INVALID_STATE,["not connected"]));var n=new y(f.UNSUBSCRIBE);n.topics=e.constructor===Array?e:[e],t.onSuccess&&(n.callback=function(){t.onSuccess({invocationContext:t.invocationContext})}),t.timeout&&(n.timeOut=new E(this,t.timeout,t.onFailure,[{invocationContext:t.invocationContext,errorCode:d.UNSUBSCRIBE_TIMEOUT.code,errorMessage:g(d.UNSUBSCRIBE_TIMEOUT)}])),this._requires_ack(n),this._schedule_message(n)},I.prototype.send=function(e){this._trace("Client.send",e);var t=new y(f.PUBLISH);if(t.payloadMessage=e,this.connected)e.qos>0?this._requires_ack(t):this.onMessageDelivered&&(this._notify_msg_sent[t]=this.onMessageDelivered(t.payloadMessage)),this._schedule_message(t);else{if(!this._reconnecting||!this.disconnectedPublishing)throw Error(g(d.INVALID_STATE,["not connected"]));if(Object.keys(this._sentMessages).length+this._buffered_msg_queue.length>this.disconnectedBufferSize)throw Error(g(d.BUFFER_FULL,[this.disconnectedBufferSize]));e.qos>0?this._requires_ack(t):(t.sequence=++this._sequence,this._buffered_msg_queue.unshift(t))}},I.prototype.disconnect=function(){if(this._trace("Client.disconnect"),this._reconnecting&&(this._reconnectTimeout.cancel(),this._reconnectTimeout=null,this._reconnecting=!1),!this.socket)throw Error(g(d.INVALID_STATE,["not connecting or connected"]));var e=new y(f.DISCONNECT);this._notify_msg_sent[e]=l(this._disconnected,this),this._schedule_message(e)},I.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date),this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var e in this._sentMessages)this._trace("_sentMessages ",e,this._sentMessages[e]);for(var e in this._receivedMessages)this._trace("_receivedMessages ",e,this._receivedMessages[e]);return this._traceBuffer}},I.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]),this._trace("Client.startTrace",new Date,"@VERSION@-@BUILDLEVEL@")},I.prototype.stopTrace=function(){delete this._traceBuffer},I.prototype._doConnect=function(e){if(this.connectOptions.useSSL){var t=e.split(":");t[0]="wss",e=t.join(":")}this._wsuri=e,this.connected=!1,(this.socket=4>this.connectOptions.mqttVersion?new WebSocket(e,["mqttv3.1"]):new WebSocket(e,["mqtt"])).binaryType="arraybuffer",this.socket.onopen=l(this._on_socket_open,this),this.socket.onmessage=l(this._on_socket_message,this),this.socket.onerror=l(this._on_socket_error,this),this.socket.onclose=l(this._on_socket_close,this),this.sendPinger=new m(this,this.connectOptions.keepAliveInterval),this.receivePinger=new m(this,this.connectOptions.keepAliveInterval),this._connectTimeout&&(this._connectTimeout.cancel(),this._connectTimeout=null),this._connectTimeout=new E(this,this.connectOptions.timeout,this._disconnected,[d.CONNECT_TIMEOUT.code,g(d.CONNECT_TIMEOUT)])},I.prototype._schedule_message=function(e){this._msg_queue.unshift(e),this.connected&&this._process_queue()},I.prototype.store=function(e,t){var n={type:t.type,messageIdentifier:t.messageIdentifier,version:1};switch(t.type){case f.PUBLISH:t.pubRecReceived&&(n.pubRecReceived=!0),n.payloadMessage={};for(var r="",o=t.payloadMessage.payloadBytes,s=0;o.length>s;s++)o[s]>15?r+=o[s].toString(16):r=r+"0"+o[s].toString(16);n.payloadMessage.payloadHex=r,n.payloadMessage.qos=t.payloadMessage.qos,n.payloadMessage.destinationName=t.payloadMessage.destinationName,t.payloadMessage.duplicate&&(n.payloadMessage.duplicate=!0),t.payloadMessage.retained&&(n.payloadMessage.retained=!0),0===e.indexOf("Sent:")&&(void 0===t.sequence&&(t.sequence=++this._sequence),n.sequence=t.sequence);break;default:throw Error(g(d.INVALID_STORED_DATA,[e+this._localKey+t.messageIdentifier,n]))}u.setItem(e+this._localKey+t.messageIdentifier,JSON.stringify(n))},I.prototype.restore=function(e){var t=u.getItem(e),n=JSON.parse(t),r=new y(n.type,n);switch(n.type){case f.PUBLISH:for(var o=n.payloadMessage.payloadHex,s=new ArrayBuffer(o.length/2),i=new Uint8Array(s),c=0;o.length>=2;){var a=parseInt(o.substring(0,2),16);o=o.substring(2,o.length),i[c++]=a}var h=new w(i);h.qos=n.payloadMessage.qos,h.destinationName=n.payloadMessage.destinationName,n.payloadMessage.duplicate&&(h.duplicate=!0),n.payloadMessage.retained&&(h.retained=!0),r.payloadMessage=h;break;default:throw Error(g(d.INVALID_STORED_DATA,[e,t]))}0===e.indexOf("Sent:"+this._localKey)?(r.payloadMessage.duplicate=!0,this._sentMessages[r.messageIdentifier]=r):0===e.indexOf("Received:"+this._localKey)&&(this._receivedMessages[r.messageIdentifier]=r)},I.prototype._process_queue=function(){for(var e=null;e=this._msg_queue.pop();)this._socket_send(e),this._notify_msg_sent[e]&&(this._notify_msg_sent[e](),delete this._notify_msg_sent[e])},I.prototype._requires_ack=function(e){var t=Object.keys(this._sentMessages).length;if(t>this.maxMessageIdentifier)throw Error("Too many messages:"+t);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;e.messageIdentifier=this._message_identifier,this._sentMessages[e.messageIdentifier]=e,e.type===f.PUBLISH&&this.store("Sent:",e),this._message_identifier===this.maxMessageIdentifier&&(this._message_identifier=1)},I.prototype._on_socket_open=function(){var e=new y(f.CONNECT,this.connectOptions);e.clientId=this.clientId,this._socket_send(e)},I.prototype._on_socket_message=function(e){this._trace("Client._on_socket_message",e.data);for(var t=this._deframeMessages(e.data),n=0;t.length>n;n+=1)this._handleMessage(t[n])},I.prototype._deframeMessages=function(e){var n=new Uint8Array(e),r=[];if(this.receiveBuffer){var o=new Uint8Array(this.receiveBuffer.length+n.length);o.set(this.receiveBuffer),o.set(n,this.receiveBuffer.length),n=o,delete this.receiveBuffer}try{for(var s=0;n.length>s;){var i=t(n,s),c=i[0];if(s=i[1],null===c)break;r.push(c)}n.length>s&&(this.receiveBuffer=n.subarray(s))}catch(e){var a="undefined"==e.hasOwnProperty("stack")?""+e.stack:"No Error Stack Available";return void this._disconnected(d.INTERNAL_ERROR.code,g(d.INTERNAL_ERROR,[e.message,a]))}return r},I.prototype._handleMessage=function(e){this._trace("Client._handleMessage",e);try{switch(e.type){case f.CONNACK:if(this._connectTimeout.cancel(),this._reconnectTimeout&&this._reconnectTimeout.cancel(),this.connectOptions.cleanSession){for(var t in this._sentMessages){_=this._sentMessages[t];u.removeItem("Sent:"+this._localKey+_.messageIdentifier)}this._sentMessages={};for(var t in this._receivedMessages){h=this._receivedMessages[t];u.removeItem("Received:"+this._localKey+h.messageIdentifier)}this._receivedMessages={}}if(0!==e.returnCode){this._disconnected(d.CONNACK_RETURNCODE.code,g(d.CONNACK_RETURNCODE,[e.returnCode,p[e.returnCode]]));break}this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);var n=[];for(var r in this._sentMessages)this._sentMessages.hasOwnProperty(r)&&n.push(this._sentMessages[r]);if(this._buffered_msg_queue.length>0)for(var o=null;o=this._buffered_msg_queue.pop();)n.push(o),this.onMessageDelivered&&(this._notify_msg_sent[o]=this.onMessageDelivered(o.payloadMessage));for(var s=0,i=(n=n.sort(function(e,t){return e.sequence-t.sequence})).length;i>s;s++)if((_=n[s]).type==f.PUBLISH&&_.pubRecReceived){a=new y(f.PUBREL,{messageIdentifier:_.messageIdentifier});this._schedule_message(a)}else this._schedule_message(_);this.connectOptions.onSuccess&&this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext});var c=!1;this._reconnecting&&(c=!0,this._reconnectInterval=1,this._reconnecting=!1),this._connected(c,this._wsuri),this._process_queue();break;case f.PUBLISH:this._receivePublish(e);break;case f.PUBACK:(_=this._sentMessages[e.messageIdentifier])&&(delete this._sentMessages[e.messageIdentifier],u.removeItem("Sent:"+this._localKey+e.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(_.payloadMessage));break;case f.PUBREC:if(_=this._sentMessages[e.messageIdentifier]){_.pubRecReceived=!0;var a=new y(f.PUBREL,{messageIdentifier:e.messageIdentifier});this.store("Sent:",_),this._schedule_message(a)}break;case f.PUBREL:var h=this._receivedMessages[e.messageIdentifier];u.removeItem("Received:"+this._localKey+e.messageIdentifier),h&&(this._receiveMessage(h),delete this._receivedMessages[e.messageIdentifier]);var l=new y(f.PUBCOMP,{messageIdentifier:e.messageIdentifier});this._schedule_message(l);break;case f.PUBCOMP:var _=this._sentMessages[e.messageIdentifier];delete this._sentMessages[e.messageIdentifier],u.removeItem("Sent:"+this._localKey+e.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(_.payloadMessage);break;case f.SUBACK:(_=this._sentMessages[e.messageIdentifier])&&(_.timeOut&&_.timeOut.cancel(),128===e.returnCode[0]?_.onFailure&&_.onFailure(e.returnCode):_.onSuccess&&_.onSuccess(e.returnCode),delete this._sentMessages[e.messageIdentifier]);break;case f.UNSUBACK:(_=this._sentMessages[e.messageIdentifier])&&(_.timeOut&&_.timeOut.cancel(),_.callback&&_.callback(),delete this._sentMessages[e.messageIdentifier]);break;case f.PINGRESP:this.sendPinger.reset();break;case f.DISCONNECT:this._disconnected(d.INVALID_MQTT_MESSAGE_TYPE.code,g(d.INVALID_MQTT_MESSAGE_TYPE,[e.type]));break;default:this._disconnected(d.INVALID_MQTT_MESSAGE_TYPE.code,g(d.INVALID_MQTT_MESSAGE_TYPE,[e.type]))}}catch(e){var v="undefined"==e.hasOwnProperty("stack")?""+e.stack:"No Error Stack Available";return void this._disconnected(d.INTERNAL_ERROR.code,g(d.INTERNAL_ERROR,[e.message,v]))}},I.prototype._on_socket_error=function(e){this._reconnecting||this._disconnected(d.SOCKET_ERROR.code,g(d.SOCKET_ERROR,[e.data]))},I.prototype._on_socket_close=function(){this._reconnecting||this._disconnected(d.SOCKET_CLOSE.code,g(d.SOCKET_CLOSE))},I.prototype._socket_send=function(e){if(1==e.type){var t=this._traceMask(e,"password");this._trace("Client._socket_send",t)}else this._trace("Client._socket_send",e);this.socket.send(e.encode()),this.sendPinger.reset()},I.prototype._receivePublish=function(e){switch(e.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(e);break;case 1:var t=new y(f.PUBACK,{messageIdentifier:e.messageIdentifier});this._schedule_message(t),this._receiveMessage(e);break;case 2:this._receivedMessages[e.messageIdentifier]=e,this.store("Received:",e);var n=new y(f.PUBREC,{messageIdentifier:e.messageIdentifier});this._schedule_message(n);break;default:throw Error("Invaild qos="+e.payloadMessage.qos)}},I.prototype._receiveMessage=function(e){this.onMessageArrived&&this.onMessageArrived(e.payloadMessage)},I.prototype._connected=function(e,t){this.onConnected&&this.onConnected(e,t)},I.prototype._reconnect=function(){this._trace("Client._reconnect"),this.connected||(this._reconnecting=!0,this.sendPinger.cancel(),this.receivePinger.cancel(),128>this._reconnectInterval&&(this._reconnectInterval=2*this._reconnectInterval),this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri))},I.prototype._disconnected=function(e,t){if(this._trace("Client._disconnected",e,t),void 0!==e&&this._reconnecting)return void(this._reconnectTimeout=new E(this,this._reconnectInterval,this._reconnect));if(this.sendPinger.cancel(),this.receivePinger.cancel(),this._connectTimeout&&(this._connectTimeout.cancel(),this._connectTimeout=null),this._msg_queue=[],this._buffered_msg_queue=[],this._notify_msg_sent={},this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),delete this.socket),this.connectOptions.uris&&this.connectOptions.uris.length-1>this.hostIndex)this.hostIndex++,this._doConnect(this.connectOptions.uris[this.hostIndex]);else if(void 0===e&&(e=d.OK.code,t=g(d.OK)),this.connected){if(this.connected=!1,this.onConnectionLost&&this.onConnectionLost({errorCode:e,errorMessage:t,reconnect:this.connectOptions.reconnect,uri:this._wsuri}),e!==d.OK.code&&this.connectOptions.reconnect)return this._reconnectInterval=1,void this._reconnect()}else 4===this.connectOptions.mqttVersion&&!1===this.connectOptions.mqttVersionExplicit?(this._trace("Failed to connect V4, dropping back to V3"),this.connectOptions.mqttVersion=3,this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri)):this.connectOptions.onFailure&&this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:e,errorMessage:t})},I.prototype._trace=function(){if(this.traceFunction){var e=Array.prototype.slice.call(arguments);for(var t in e)void 0!==e[t]&&e.splice(t,1,JSON.stringify(e[t]));var n=e.join("");this.traceFunction({severity:"Debug",message:n})}if(null!==this._traceBuffer)for(var t=0,r=arguments.length;r>t;t++)this._traceBuffer.length==this._MAX_TRACE_ENTRIES&&this._traceBuffer.shift(),this._traceBuffer.push(0===t?arguments[t]:void 0===arguments[t]?arguments[t]:"  "+JSON.stringify(arguments[t]))},I.prototype._traceMask=function(e,t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=r==t?"******":e[r]);return n};var b=function(e,t,n,r){var o;if("string"!=typeof e)throw Error(g(d.INVALID_TYPE,[typeof e,"host"]));if(2==arguments.length){r=t;var s=(o=e).match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(!s)throw Error(g(d.INVALID_ARGUMENT,[e,"host"]));e=s[4]||s[2],t=parseInt(s[7]),n=s[8]}else{if(3==arguments.length&&(r=n,n="/mqtt"),"number"!=typeof t||0>t)throw Error(g(d.INVALID_TYPE,[typeof t,"port"]));if("string"!=typeof n)throw Error(g(d.INVALID_TYPE,[typeof n,"path"]));var i=-1!==e.indexOf(":")&&"["!==e.slice(0,1)&&"]"!==e.slice(-1);o="ws://"+(i?"["+e+"]":e)+":"+t+n}for(var c=0,a=0;r.length>a;a++){var u=r.charCodeAt(a);55296>u||u>56319||a++,c++}if("string"!=typeof r||c>65535)throw Error(g(d.INVALID_ARGUMENT,[r,"clientId"]));var f=new I(o,e,t,n,r);Object.defineProperties(this,{host:{get:function(){return e},set:function(){throw Error(g(d.UNSUPPORTED_OPERATION))}},port:{get:function(){return t},set:function(){throw Error(g(d.UNSUPPORTED_OPERATION))}},path:{get:function(){return n},set:function(){throw Error(g(d.UNSUPPORTED_OPERATION))}},uri:{get:function(){return o},set:function(){throw Error(g(d.UNSUPPORTED_OPERATION))}},clientId:{get:function(){return f.clientId},set:function(){throw Error(g(d.UNSUPPORTED_OPERATION))}},onConnected:{get:function(){return f.onConnected},set:function(e){if("function"!=typeof e)throw Error(g(d.INVALID_TYPE,[typeof e,"onConnected"]));f.onConnected=e}},disconnectedPublishing:{get:function(){return f.disconnectedPublishing},set:function(e){f.disconnectedPublishing=e}},disconnectedBufferSize:{get:function(){return f.disconnectedBufferSize},set:function(e){f.disconnectedBufferSize=e}},onConnectionLost:{get:function(){return f.onConnectionLost},set:function(e){if("function"!=typeof e)throw Error(g(d.INVALID_TYPE,[typeof e,"onConnectionLost"]));f.onConnectionLost=e}},onMessageDelivered:{get:function(){return f.onMessageDelivered},set:function(e){if("function"!=typeof e)throw Error(g(d.INVALID_TYPE,[typeof e,"onMessageDelivered"]));f.onMessageDelivered=e}},onMessageArrived:{get:function(){return f.onMessageArrived},set:function(e){if("function"!=typeof e)throw Error(g(d.INVALID_TYPE,[typeof e,"onMessageArrived"]));f.onMessageArrived=e}},trace:{get:function(){return f.traceFunction},set:function(e){if("function"!=typeof e)throw Error(g(d.INVALID_TYPE,[typeof e,"onTrace"]));f.traceFunction=e}}}),this.connect=function(e){if(e=e||{},h(e,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",reconnect:"boolean",mqttVersion:"number",mqttVersionExplicit:"boolean",uris:"object"}),void 0===e.keepAliveInterval&&(e.keepAliveInterval=60),e.mqttVersion>4||3>e.mqttVersion)throw Error(g(d.INVALID_ARGUMENT,[e.mqttVersion,"connectOptions.mqttVersion"]));if(void 0===e.mqttVersion?(e.mqttVersionExplicit=!1,e.mqttVersion=4):e.mqttVersionExplicit=!0,void 0!==e.password&&void 0===e.userName)throw Error(g(d.INVALID_ARGUMENT,[e.password,"connectOptions.password"]));if(e.willMessage){if(!(e.willMessage instanceof w))throw Error(g(d.INVALID_TYPE,[e.willMessage,"connectOptions.willMessage"]));if(e.willMessage.stringPayload=null,void 0===e.willMessage.destinationName)throw Error(g(d.INVALID_TYPE,[typeof e.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}if(void 0===e.cleanSession&&(e.cleanSession=!0),e.hosts){if(!(e.hosts instanceof Array))throw Error(g(d.INVALID_ARGUMENT,[e.hosts,"connectOptions.hosts"]));if(1>e.hosts.length)throw Error(g(d.INVALID_ARGUMENT,[e.hosts,"connectOptions.hosts"]));for(var t=!1,r=0;e.hosts.length>r;r++){if("string"!=typeof e.hosts[r])throw Error(g(d.INVALID_TYPE,[typeof e.hosts[r],"connectOptions.hosts["+r+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(e.hosts[r])){if(0===r)t=!0;else if(!t)throw Error(g(d.INVALID_ARGUMENT,[e.hosts[r],"connectOptions.hosts["+r+"]"]))}else if(t)throw Error(g(d.INVALID_ARGUMENT,[e.hosts[r],"connectOptions.hosts["+r+"]"]))}if(t)e.uris=e.hosts;else{if(!e.ports)throw Error(g(d.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));if(!(e.ports instanceof Array))throw Error(g(d.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));if(e.hosts.length!==e.ports.length)throw Error(g(d.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));e.uris=[];for(r=0;e.hosts.length>r;r++){if("number"!=typeof e.ports[r]||0>e.ports[r])throw Error(g(d.INVALID_TYPE,[typeof e.ports[r],"connectOptions.ports["+r+"]"]));var s=e.hosts[r],i=e.ports[r],c=-1!==s.indexOf(":");o="ws://"+(c?"["+s+"]":s)+":"+i+n,e.uris.push(o)}}}f.connect(e)},this.subscribe=function(e,t){if("string"!=typeof e&&e.constructor!==Array)throw Error("Invalid argument:"+e);if(t=t||{},h(t,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),t.timeout&&!t.onFailure)throw Error("subscribeOptions.timeout specified with no onFailure callback.");if(void 0!==t.qos&&0!==t.qos&&1!==t.qos&&2!==t.qos)throw Error(g(d.INVALID_ARGUMENT,[t.qos,"subscribeOptions.qos"]));f.subscribe(e,t)},this.unsubscribe=function(e,t){if("string"!=typeof e&&e.constructor!==Array)throw Error("Invalid argument:"+e);if(t=t||{},h(t,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),t.timeout&&!t.onFailure)throw Error("unsubscribeOptions.timeout specified with no onFailure callback.");f.unsubscribe(e,t)},this.send=function(e,t,n,r){var o;if(0===arguments.length)throw Error("Invalid argument.length");if(1==arguments.length){if(!(e instanceof w)&&"string"!=typeof e)throw Error("Invalid argument:"+typeof e);if(void 0===(o=e).destinationName)throw Error(g(d.INVALID_ARGUMENT,[o.destinationName,"Message.destinationName"]));f.send(o)}else(o=new w(t)).destinationName=e,3>arguments.length||(o.qos=n),4>arguments.length||(o.retained=r),f.send(o)},this.publish=function(e,t,n,r){var o;if(0===arguments.length)throw Error("Invalid argument.length");if(1==arguments.length){if(!(e instanceof w)&&"string"!=typeof e)throw Error("Invalid argument:"+typeof e);if(void 0===(o=e).destinationName)throw Error(g(d.INVALID_ARGUMENT,[o.destinationName,"Message.destinationName"]));f.send(o)}else(o=new w(t)).destinationName=e,3>arguments.length||(o.qos=n),4>arguments.length||(o.retained=r),f.send(o)},this.disconnect=function(){f.disconnect()},this.getTraceLog=function(){return f.getTraceLog()},this.startTrace=function(){f.startTrace()},this.stopTrace=function(){f.stopTrace()},this.isConnected=function(){return f.connected}},w=function(e){var t;if(!("string"==typeof e||e instanceof ArrayBuffer||ArrayBuffer.isView(e)&&!(e instanceof DataView)))throw g(d.INVALID_ARGUMENT,[e,"newPayload"]);t=e;var n,r=0,o=!1,s=!1;Object.defineProperties(this,{payloadString:{enumerable:!0,get:function(){if("string"==typeof t)return t;try{return a(t,0,t.length)}catch(e){return"<"+typeof t+">"}}},payloadBytes:{enumerable:!0,get:function(){if("string"==typeof t){var e=new ArrayBuffer(i(t)),n=new Uint8Array(e);return c(t,n,0),n}return t}},destinationName:{enumerable:!0,get:function(){return n},set:function(e){if("string"!=typeof e)throw Error(g(d.INVALID_ARGUMENT,[e,"newDestinationName"]));n=e}},qos:{enumerable:!0,get:function(){return r},set:function(e){if(0!==e&&1!==e&&2!==e)throw Error("Invalid argument:"+e);r=e}},retained:{enumerable:!0,get:function(){return o},set:function(e){if("boolean"!=typeof e)throw Error(g(d.INVALID_ARGUMENT,[e,"newRetained"]));o=e}},topic:{enumerable:!0,get:function(){return n},set:function(e){n=e}},duplicate:{enumerable:!0,get:function(){return s},set:function(e){s=e}}})};return{Client:b,Message:w}}(void 0!==s?s:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})})}),c=e(function(e){!function(t,n){function r(e,t){function r(e){for(var t=_.byteLength,n=m+e;n>t;)t<<=1;if(t!==_.byteLength){var r=v;_=new ArrayBuffer(t),v=new DataView(_),y=new Uint8Array(_);for(var o=m+3>>2,s=0;o>s;++s)v.setUint32(s<<2,r.getUint32(s<<2))}return g=e,v}function o(){m+=g}function s(e){o(r(8).setFloat64(m,e))}function a(e){o(r(1).setUint8(m,e))}function u(e){r(e.length),y.set(e,m),o()}function f(e){o(r(2).setUint16(m,e))}function h(e){o(r(4).setUint32(m,e))}function l(e){var t=e%i,n=(e-t)/i,s=r(8);s.setUint32(m,n),s.setUint32(m+4,t),o()}function d(e,t){24>t?a(e<<5|t):256>t?(a(e<<5|24),a(t)):65536>t?(a(e<<5|25),f(t)):4294967296>t?(a(e<<5|26),h(t)):(a(e<<5|27),l(t))}function p(e){var r;if(!1===e)return a(244);if(!0===e)return a(245);if(null===e)return a(246);if(e===n)return a(247);switch(typeof e){case"number":if(Math.floor(e)===e){if(e>=0&&c>=e)return d(0,e);if(e>=-c&&0>e)return d(1,-(e+1))}return a(251),s(e);case"string":var o=[];for(r=0;e.length>r;++r){var i=e.charCodeAt(r);128>i?o.push(i):2048>i?(o.push(192|i>>6),o.push(128|63&i)):55296>i?(o.push(224|i>>12),o.push(128|i>>6&63),o.push(128|63&i)):(i=(1023&i)<<10,i|=1023&e.charCodeAt(++r),i+=65536,o.push(240|i>>18),o.push(128|i>>12&63),o.push(128|i>>6&63),o.push(128|63&i))}return d(3,o.length),u(o);default:var f;if(Array.isArray(e))for(d(4,f=e.length),r=0;f>r;++r)p(e[r]);else if(e instanceof Uint8Array)d(2,e.length),u(e);else{var h=Object.keys(e);for(d(5,f=h.length),r=0;f>r;++r){var l=h[r];t&&(l=parseInt(l)),p(l),p(e[l])}}}}var g,_=new ArrayBuffer(256),v=new DataView(_),y=new Uint8Array(_),m=0;if(p(e),"slice"in _)return _.slice(0,m);for(var E=new ArrayBuffer(m),I=new DataView(E),b=0;m>b;++b)I.setUint8(b,v.getUint8(b));return E}function o(e,t,r){function o(e,t){return b+=e,t}function c(t){return o(t,new Uint8Array(e,b,t))}function u(){var e=new ArrayBuffer(4),t=new DataView(e),n=d(),r=32768&n,o=31744&n,i=1023&n;if(31744===o)o=261120;else if(0!==o)o+=114688;else if(0!==i)return(r?-1:1)*i*s;return t.setUint32(0,r<<16|o<<13|i<<13),t.getFloat32(0)}function f(){return o(4,I.getFloat32(b))}function h(){return o(8,I.getFloat64(b))}function l(){return o(1,I.getUint8(b))}function d(){return o(2,I.getUint16(b))}function p(){return o(4,I.getUint32(b))}function g(){return p()*i+p()}function _(){return 255===I.getUint8(b)&&(b+=1,!0)}function v(e){if(24>e)return e;if(24===e)return l();if(25===e)return d();if(26===e)return p();if(27===e)return g();if(31===e)return-1;throw"Invalid length encoding"}function y(e){var t=l();if(255===t)return-1;var n=v(31&t);if(0>n||t>>5!==e)throw"Invalid indefinite length element";return n}function m(e,t){for(var n=0;t>n;++n){var r=l();128&r&&(224>r?(r=(31&r)<<6|63&l(),t-=1):240>r?(r=(15&r)<<12|(63&l())<<6|63&l(),t-=2):(r=(15&r)<<18|(63&l())<<12|(63&l())<<6|63&l(),t-=3)),65536>r?e.push(r):(r-=65536,e.push(55296|r>>10),e.push(56320|1023&r))}}function E(){var e,o,s=l(),i=s>>5,d=31&s;if(7===i)switch(d){case 25:return u();case 26:return f();case 27:return h()}if(0>(o=v(d))&&(2>i||i>6))throw"Invalid length";switch(i){case 0:return o;case 1:return-1-o;case 2:if(0>o){for(var p=[],g=0;(o=y(i))>=0;)g+=o,p.push(c(o));var I=new Uint8Array(g),b=0;for(e=0;p.length>e;++e)I.set(p[e],b),b+=p[e].length;return I}return c(o);case 3:var w=[];if(0>o)for(;(o=y(i))>=0;)m(w,o);else m(w,o);var M="";for(e=0;w.length>e;e+=a)M+=String.fromCharCode.apply(null,w.slice(e,e+a));return M;case 4:var A;if(0>o)for(A=[];!_();)A.push(E());else for(A=Array(o),e=0;o>e;++e)A[e]=E();return A;case 5:var C={};for(e=0;o>e||0>o&&!_();++e)C[E()]=E();return C;case 6:return t(E(),o);case 7:switch(o){case 20:return!1;case 21:return!0;case 22:return null;case 23:return n;default:return r(o)}}}var I=new DataView(e),b=0;"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof r&&(r=function(){return n});var w=E();if(b!==e.byteLength)throw"Remaining bytes";return w}const s=5.960464477539063e-8,i=4294967296,c=9007199254740992,a=8192;var u={encode:r,decode:o};"function"==typeof n&&n.amd?n("cbor/cbor",u):e.exports?e.exports=u:t.CBOR||(t.CBOR=u)}(s)}),a=function(e){function o(e,r){t(this,o);var s=n(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,r));s.name=s.constructor.name;try{Error.captureStackTrace(s,s.constructor)}catch(e){}return s.code=e,s}return r(o,e),o}(Error),u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f=null,h=null,l={},d={},p=function(e,t){return fetch(e,{method:"get",headers:new Headers({Authorization:"Bearer "+t,"Content-Type":"application/json"})}).then(function(e){return e.json()})},g=function(e){return new Promise(function(t,n){var r=!1;!1!==e.ssl&&(r=!0);var o={host:e.host||"wss.iot.arduino.cc",port:e.port||8443,apiUrl:e.apiUrl||"https://api2.arduino.cc",ssl:r,token:e.token,onDisconnect:e.onDisconnect,onTrace:e.onTrace,onConnected:e.onConnected,useCloudProtocolV2:e.useCloudProtocolV2||!1};return h=o,f?n(Error("connection failed: connection already open")):o.host?o.token?o.apiUrl?p(o.apiUrl+"/users/v1/users/byID/me",e.token).then(function(e){var r=e.id+":"+(new Date).getTime(),s=new i.Client(o.host,o.port,r);s.topics={},s.properties={},s.onMessageArrived=function(e){if(e.topic.indexOf("/s/o")>-1)s.topics[e.topic].forEach(function(t){t(e.payloadString)});else{for(var t=new ArrayBuffer(e.payloadBytes.length),n=new Uint8Array(t),r=0,o=e.payloadBytes.length;o>r;r+=1)n[r]=e.payloadBytes[r];var i={},a="",u="";c.decode(t).forEach(function(t){var n=(u=void 0!==t.n?t.n:t[0]).split(":"),r=void 0!==t.v?"v":"2",o=void 0!==t.vs?"vs":"3",s=void 0!==t.vb?"vb":"4",c=null;u=n[0],d[e.topic][u]&&(void 0!==t[r]?c=t[r]:void 0!==t[o]?c=t[o]:void 0!==t[s]&&(c=t[s])),""===a&&(a=n[0]),a!==u&&(d[e.topic][a]&&d[e.topic][a](i),a=u,i={}),1===n.length&&null!==c?i=c:i[n[1]]=c}),i!=={}&&d[e.topic][u]&&d[e.topic][u](i)}},s.onConnected=function(e){var t=[];return!0===e&&Object.values(l).forEach(function(e){t.push(function(){return y(e.topic,e.cb)})}),Promise.all(t).then(function(){"function"==typeof o.onConnected&&o.onConnected(e)})},"function"==typeof onDisconnect&&(s.onConnectionLost=o.onDisconnect);var u={useSSL:o.ssl,timeout:30,mqttVersion:4,userName:e.id,mqttVersionExplicit:!0,reconnect:!0,keepAliveInterval:30,onSuccess:function(){return f=s,t()},onFailure:function(e){return n(new a(e.errorCode,e.errorMessage))}};u.password=o.token,"function"==typeof o.onTrace&&(s.trace=function(e){o.onTrace(e)}),s.connect(u)},n):n(Error("no apiUrl parameter is provided")):n(Error("connection failed: you need to provide a valid token")):n(Error("connection failed: you need to provide a valid host (broker)"))})},_=function(){return new Promise(function(e,t){if(!f)return t(Error("disconnection failed: connection closed"));try{f.disconnect()}catch(e){return t(e)}return f=null,Object.keys(d).forEach(function(e){d[e]&&delete d[e]}),Object.keys(l).forEach(function(e){delete l[e]}),e()})},v=function(){function e(e){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=1,f&&(f.disconnect(),f=null),n=Object.assign({},h,{token:t}),e.next=6,g(n);case 6:return Object.values(l).forEach(function(e){y(e.topic,e.cb)}),"function"==typeof h.onConnected&&h.onConnected(!0),e.abrupt("return");case 11:return e.prev=11,e.t0=e.catch(1),console.error(e.t0),e.next=16,new Promise(function(e){setTimeout(e,5e3)});case 16:e.next=0;break;case 18:case"end":return e.stop()}},e,this,[[1,11]])}));return e}(),y=function(e,t){return new Promise(function(n,r){return f?f.subscribe(e,{onSuccess:function(){return f.topics[e]||(f.topics[e]=[]),f.topics[e].push(t),n(e)},onFailure:function(e){return r(Error("subscription failed: "+e.errorMessage))}}):r(Error("subscription failed: connection closed"))})},m=function(e){return new Promise(function(t,n){return f?f.unsubscribe(e,{onSuccess:function(){return t(e)},onFailure:function(){return n()}}):n(Error("disconnection failed: connection closed"))})},E=function(e){for(var t="",n=new Uint8Array(e),r=n.byteLength,o=0;r>o;o+=1)t+=String.fromCharCode(n[o]);return window.btoa(t)},I=function(e,t){return new Promise(function(n,r){return f?(f.publish(e,t,1,!1),n()):r(Error("disconnection failed: connection closed"))})},b=function(e){var t={},n=null;return Object.keys(e).forEach(function(r){switch(r){case"bn":n=-2;break;case"bt":n=-3;break;case"bu":n=-4;break;case"bv":n=-5;break;case"bs":n=-6;break;case"bver":n=-1;break;case"n":n=0;break;case"u":n=1;break;case"v":n=2;break;case"vs":n=3;break;case"vb":n=4;break;case"vd":n=8;break;case"s":n=5;break;case"t":n=6;break;case"ut":n=7;break;default:n=r}t[n]=e[r]}),t},w=function(e,t,n,r){if(r&&!Number.isInteger(r))throw Error("Timestamp must be Integer");if(void 0===t||"string"!=typeof t)throw Error("Name must be a valid string");if("object"===(void 0===n?"undefined":u(n)))return Object.keys(n).map(function(o,s){var i={n:t+":"+o};switch(0===s&&(i.bt=r||(new Date).getTime(),e&&(i.bn="urn:uuid:"+e)),u(n[o])){case"string":i.vs=n[o];break;case"number":i.v=n[o];break;case"boolean":i.vb=n[o]}return i}).map(function(e){return h.useCloudProtocolV2?b(e):e});var o={bt:r||(new Date).getTime(),n:t};switch(e&&(o.bn="urn:uuid:"+e),void 0===n?"undefined":u(n)){case"string":o.vs=n;break;case"number":o.v=n;break;case"boolean":o.vb=n}return h.useCloudProtocolV2?b(o):o};return{connect:g,disconnect:_,updateToken:v,subscribe:y,unsubscribe:m,sendMessage:I,openCloudMonitor:function(e,t){return y("/a/d/"+e+"/s/o",t)},writeCloudMonitor:function(e,t){return I("/a/d/"+e+"/s/i",t)},closeCloudMonitor:function(e){return m("/a/d/"+e+"/s/o")},sendProperty:function(e,t,n,r){var o="/a/t/"+e+"/e/i";if(r&&!Number.isInteger(r))throw Error("Timestamp must be Integer");if(void 0===t||"string"!=typeof t)throw Error("Name must be a valid string");if("object"===(void 0===n?"undefined":u(n))){var s=Object.keys(n).map(function(e,o){var s={n:t+":"+e};switch(0===o&&(s.bt=r||(new Date).getTime()),u(n[e])){case"string":s.vs=n[e];break;case"number":s.v=n[e];break;case"boolean":s.vb=n[e]}return s}).map(function(e){return h.useCloudProtocolV2?b(e):e});return I(o,c.encode(s,!0))}var i={bt:r||(new Date).getTime(),n:t};switch(void 0===n?"undefined":u(n)){case"string":i.vs=n;break;case"number":i.v=n;break;case"boolean":i.vb=n}return h.useCloudProtocolV2&&(i=b(i)),I(o,c.encode([i],!0))},sendPropertyAsDevice:function(e,t,n,r,o){var s="/a/t/"+t+"/e/o";if(o&&!Number.isInteger(o))throw Error("Timestamp must be Integer");if(void 0===n||"string"!=typeof n)throw Error("Name must be a valid string");var i=w(e,n,r,o);return I(s,c.encode([i]))},onPropertyValue:function(e,t,n){if(!t)throw Error("Invalid property name");if("function"!=typeof n)throw Error("Invalid callback");var r="/a/t/"+e+"/e/o";return l[e]={topic:r,cb:n},d[r]?(d[r]&&!d[r][t]&&(d[r][t]=n),Promise.resolve(r)):(d[r]={},d[r][t]=n,y(r,n))},removePropertyValueCallback:function(e,t){if(!t)throw Error("Invalid property name");var n="/a/t/"+e+"/e/o";return delete d[n][t],Promise.resolve(n)},getCborValue:function(e){var t=c.encode(e);return E(t)},getSenml:w,ArduinoCloudError:a}});
